<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA Manager - VKU Expert</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --icon-color: #64748b;
            
            --grade-A: #22c55e;
            --grade-B: #3b82f6;
            --grade-C: #a855f7;
            --grade-D: #eab308;
            --grade-F: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 13.5px; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Header & Controls */
        header { 
            background: var(--surface); padding: 15px 20px; border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 3px solid var(--primary);
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .btn { 
            border: 1px solid var(--border); background: var(--surface); color: var(--text); 
            padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; 
            transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 13px;
        }
        .btn svg { width: 16px; height: 16px; fill: var(--icon-color); }
        .btn:hover { border-color: var(--primary); background: #f0f9ff; color: var(--primary); }
        .btn:hover svg { fill: var(--primary); }
        
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary svg { fill: white; }
        .btn-primary:hover { background: var(--primary-dark); color: white; }
        .btn-primary:hover svg { fill: white; }

        .btn-danger { color: #ef4444; border-color: #fee2e2; background: #fef2f2; padding: 4px 8px; font-size: 12px; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-danger svg { fill: #ef4444; width: 14px; height: 14px; }
        
        .btn-code { background: #7c3aed; color: white; border-color: #7c3aed; }
        .btn-code svg { fill: white; }
        .btn-code:hover { background: #6d28d9; }

        /* Summary Bar */
        .summary-bar {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            background: linear-gradient(to right, var(--primary-dark), var(--primary));
            color: white; padding: 15px; border-radius: 10px; margin-bottom: 25px;
            text-align: center; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2);
        }
        .sum-item div:first-child { font-size: 0.85rem; opacity: 0.9; }
        .sum-item div:last-child { font-size: 1.5rem; font-weight: 700; }

        /* Card */
        .card { background: var(--surface); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .sem-title { border: none; font-size: 1.1rem; font-weight: 700; color: var(--primary-dark); width: 250px; background: transparent; }
        .sem-stats { display: flex; gap: 15px; font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 4px 12px; border-radius: 20px; }

        /* --- TABLE & INPUT FIX --- */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        /* C·ªë ƒë·ªãnh chi·ªÅu cao d√≤ng ƒë·ªÉ input fill ƒë·∫ßy */
        td { 
            padding: 0; /* X√≥a padding c·ªßa TD ƒë·ªÉ input tr√†n vi·ªÅn */
            border: 1px solid #e2e8f0; 
            text-align: center; 
            vertical-align: middle; 
            height: 36px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
            position: relative;
        }
        th { text-align: center; background: #f8fafc; padding: 10px; font-weight: 600; font-size: 0.8rem; color: #475569; border: 1px solid #e2e8f0; }

        /* Input style m·ªõi: Tr√†n vi·ªÅn, kh√¥ng border */
        input.cell-input, select.cell-input { 
            width: 100%; 
            height: 100%; 
            border: none; 
            padding: 0 5px; /* Padding nh·∫π b√™n trong text */
            text-align: center; 
            font-family: inherit; 
            background: transparent; 
            font-weight: 500;
            display: block;
            box-sizing: border-box;
        }
        
        input.cell-input:hover, select.cell-input:hover { background: #f8fafc; }
        
        input.cell-input:focus, select.cell-input:focus { 
            outline: 2px solid var(--primary); 
            background: white; 
            z-index: 10; 
            position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Highlight Row Animation */
        @keyframes flashHighlight {
            0% { background-color: #fde047; }
            100% { background-color: transparent; }
        }
        .highlight-row { animation: flashHighlight 2s ease-out; }

        /* Colors */
        .g-A { color: var(--grade-A); }
        .g-B { color: var(--grade-B); }
        .g-C { color: var(--grade-C); }
        .g-D { color: var(--grade-D); }
        .g-F { color: var(--grade-F); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal {
            background: white; width: 600px; max-width: 90%; border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: translateY(20px); transition: 0.3s; position: relative;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        .btn-close-modal {
            position: absolute; top: 15px; right: 20px;
            border: none; background: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8;
        }
        .btn-close-modal:hover { color: #ef4444; }

        /* Code Block Style */
        .code-container {
            background: #1e293b; color: #e2e8f0; padding: 15px; 
            border-radius: 8px; font-family: 'Consolas', monospace; font-size: 12px;
            overflow-y: auto; height: 300px; margin: 15px 0;
            white-space: pre-wrap; word-break: break-all;
            text-align: left;
            border: 1px solid #334155;
        }

        /* Delete Modal */
        .btn-confirm-del { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-cancel-del { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .hidden { display: none; }
        .btn-add-row { width: 100%; margin-top: 10px; padding: 8px; border: 1px dashed #cbd5e1; color: #64748b; background: #f8fafc; border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-add-row:hover { border-color: var(--primary); color: var(--primary); background: #f0f9ff; }
        .btn-add-row svg { fill: currentColor; width: 14px; height: 14px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>GPA Manager</h1>
        <div class="controls">
            <input type="file" id="jsonInput" accept=".json" style="display:none">
            
            <button class="btn" onclick="document.getElementById('jsonInput').click()">
                <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                M·ªü File
            </button>
            
            <button class="btn" onclick="closeFile()">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                ƒê√≥ng File
            </button>
            
            <button class="btn" onclick="saveData()">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                L∆∞u
            </button>
            
            <button class="btn btn-primary" onclick="showSuggestions()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                Ph√¢n t√≠ch
            </button>

            <button class="btn btn-code" onclick="showScriptModal()">
                <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                Script l·∫•y ƒëi·ªÉm
            </button>
        </div>
    </header>

    <div class="summary-bar">
        <div class="sum-item">
            <div>GPA H·ªá 4</div>
            <div id="sum-gpa4">0.00</div>
        </div>
        <div class="sum-item">
            <div>GPA H·ªá 10</div>
            <div id="sum-gpa10">0.00</div>
        </div>
        <div class="sum-item">
            <div>T·ªïng T√≠n Ch·ªâ</div>
            <div id="sum-tc">0</div>
        </div>
        <div class="sum-item">
            <div>S·ªë M√¥n</div>
            <div id="sum-count">0</div>
        </div>
    </div>

    <div id="semester-container"></div>
    
    <button onclick="addSemester()" style="width:100%; padding:15px; margin-top:20px; background:white; border:2px dashed #cbd5e1; color:#64748b; font-weight:600; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; gap:10px;">
        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#64748b"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Th√™m H·ªçc K·ª≥ M·ªõi
    </button>
</div>

<div class="modal-overlay" id="scriptModal">
    <div class="modal">
        <button class="btn-close-modal" onclick="closeScriptModal()">&times;</button>
        <h2 style="margin:0; font-size:1.3rem; color:var(--primary-dark)">üíª Script L·∫•y ƒêi·ªÉm</h2>
        <p style="color:#64748b; font-size:0.9rem; margin-top:5px;">Copy ƒëo·∫°n code d∆∞·ªõi ƒë√¢y v√† d√°n v√†o Console (F12) t·∫°i trang ƒëi·ªÉm ƒë·ªÉ t·∫£i file JSON.</p>
        
        <div class="code-container" id="jsCodeBlock">
(function() {
    const GPA_SCALE = {
        'A': 4.0, 'B': 3.0, 'C': 2.0, 'D': 1.0, 'F': 0.0,
        null: 0.0
    };

    function scoreToLetterGrade(score) {
        if (score === null || score < 4.0) return 'F';
        if (score >= 8.5) return 'A';
        if (score >= 7.0) return 'B';
        if (score >= 5.5) return 'C';
        if (score >= 4.0) return 'D';
        return 'F';
    }

    const scoreTableBody = $('.x_content .table-responsive table tbody');
    if (scoreTableBody.length === 0) {
        console.error("Kh√¥ng t√¨m th·∫•y b·∫£ng ƒëi·ªÉm chi ti·∫øt.");
        return;
    }

    const resultData = {};
    let currentAcademicYear = null;
    let currentSemester = null;

    function parseSemesterString(headerText) {
        const parts = headerText.trim().split(' - ');
        if (parts.length === 2) {
            return {
                semester: parts[0].trim(),
                academicYear: parts[1].trim()
            };
        } else if (headerText.includes("H·ªçc k·ª≥ ri√™ng - Quy ƒë·ªïi")) {
            return {
                semester: "H·ªçc k·ª≥ ri√™ng",
                academicYear: "Quy ƒë·ªïi"
            };
        }
        return { semester: headerText.trim(), academicYear: "Kh√¥ng r√µ" };
    }

    scoreTableBody.find('tr').each(function() {
        const row = $(this);
        const semesterHeader = row.find('td[colspan="13"]');
        if (semesterHeader.length > 0) {
            const fullHeader = semesterHeader.text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            const parsed = parseSemesterString(fullHeader);
            currentSemester = parsed.semester;
            currentAcademicYear = parsed.academicYear;
            
            if (currentAcademicYear === "Quy ƒë·ªïi") {
                console.log(`B·ªè qua H·ªçc k·ª≥: ${currentSemester} - ${currentAcademicYear}`);
                currentSemester = null; 
                return; 
            }
            
            if (!resultData[currentAcademicYear]) {
                resultData[currentAcademicYear] = {};
            }
            if (!resultData[currentAcademicYear][currentSemester]) {
                resultData[currentAcademicYear][currentSemester] = [];
            }
            return; 
        }

        const columns = row.find('td');
        if (columns.length >= 10 && currentSemester && currentAcademicYear && currentAcademicYear !== "Quy ƒë·ªïi") {
            const stt = $(columns[0]).attr('title') || $(columns[0]).text().trim(); 
            const tenLHP = $(columns[1]).text().trim()
                            .replace(/[\r\n\t]+/g, '')
                            .replace(/\s{2,}/g, ' ')
                            .replace(/(\s*(?:\[Image of.*\]\s*))/g, '')
                            .replace(/\s*(\u2713|\u2714|\u2611|\u2714\uFE0F|\u2713\uFE0F|glyphicon-ok|glyphicon-inbox|ƒê√°nh gi√° s·ª± c·∫ßn thi·∫øt c·ªßa H·ªçc ph·∫ßn)/g, '')
                            .replace(/^(L·ªõp ƒë·ªì √°n|ƒê·ªì √°n c∆° s·ªü) \d+ \w+\s*/, '')
                            .trim();

            const soTC = $(columns[2]).text().trim();
            const lanHoc = $(columns[3]).text().trim();
            const diemCC = $(columns[4]).text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            const diemBT = $(columns[5]).text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            const diemGK = $(columns[6]).text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            const diemCK = $(columns[7]).text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            const diemT10 = $(columns[8]).text().trim().replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ');
            
            const safeParseFloat = (str) => {
                const num = parseFloat(str);
                return isNaN(num) ? null : num;
            };

            const finalScore10 = safeParseFloat(diemT10);
            const finalLetter = scoreToLetterGrade(finalScore10);
            const finalScore4 = finalLetter !== null ? GPA_SCALE[finalLetter] : null;

            const subjectData = {
                "STT_ID": stt.length > 0 ? stt : null,
                "TenLopHocPhan": tenLHP,
                "SoTinChi": parseInt(soTC) || null,
                "LanHoc": parseInt(lanHoc) || null,
                "DiemThanhPhan": {
                    "ChuyenCan_GVHD": safeParseFloat(diemCC),
                    "BaiTap": safeParseFloat(diemBT),
                    "GiuaKy": safeParseFloat(diemGK),
                    "CuoiKy_DoAn": safeParseFloat(diemCK),
                },
                "DiemTongKet": {
                    "He10": finalScore10,
                    "He4": finalScore4,
                    "DiemChu": finalLetter
                }
            };
            resultData[currentAcademicYear][currentSemester].push(subjectData);
        }
    });

    const jsonOutput = JSON.stringify(resultData, null, 2);
    console.log("D·ªØ li·ªáu ƒëi·ªÉm ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t th√†nh c√¥ng.");
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonOutput);
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "DiemSinhVien_VKU_Export.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    document.body.removeChild(downloadAnchorNode);
})();
        </div>

        <button onclick="copyToClipboard()" class="btn btn-primary" style="justify-content:center; padding:12px;">
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            Copy Code
        </button>
    </div>
</div>

<div class="modal-overlay" id="suggestionModal">
    <div class="modal">
        <button class="btn-close-modal" onclick="closeSuggestions()">&times;</button>
        <div style="margin-bottom:15px;">
            <h2 style="margin:0; font-size:1.3rem; color:var(--primary-dark)">üéØ G·ª£i √Ω C·∫£i thi·ªán ƒëi·ªÉm</h2>
        </div>
        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center">
            <div>
                <label style="font-weight:600; margin-right:10px;">M·ª•c ti√™u GPA (4.0):</label>
                <input type="number" id="targetGPA" value="3.20" step="0.01" style="width:70px; font-weight:bold; background:white; border:1px solid #ccc; padding:5px; border-radius:4px" onchange="renderSuggestionContent()">
            </div>
            <div id="target-status" style="font-size:0.95rem; font-weight:600"></div>
        </div>
        <div id="suggestion-list" style="max-height: 350px; overflow-y: auto;"></div>
    </div>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal" style="width: 400px;">
        <button class="btn-close-modal" onclick="closeDeleteModal()">&times;</button>
        <div style="text-align:center">
            <div style="background:#fee2e2; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto;">
                <svg viewBox="0 0 24 24" style="fill:#ef4444; width:30px; height:30px;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </div>
            <h3 style="margin:0 0 10px 0; color:#1e293b;">X√°c nh·∫≠n x√≥a</h3>
            <p style="color:#64748b; margin:0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô h·ªçc k·ª≥ n√†y?<br>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            <div style="margin-top:20px; display:flex; justify-content:center; gap:15px;">
                <button class="btn-cancel-del" onclick="closeDeleteModal()">H·ªßy b·ªè</button>
                <button class="btn-confirm-del" onclick="confirmDelete()">ƒê·ªìng √Ω x√≥a</button>
            </div>
        </div>
    </div>
</div>

<script>
    let semesters = [];
    let pendingDeleteId = null; 
    
    // --- MAIN LOGIC ---
    function initEmpty() {
        semesters = [{ id: genId(), name: '2024-2025 - H·ªçc k·ª≥ 1', subjects: [] }];
        render();
    }
    
    // ƒê√≥ng file: Reset v·ªÅ m·∫£ng r·ªóng v√† render l·∫°i
    function closeFile() {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng file? D·ªØ li·ªáu ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.")) {
            semesters = [];
            render();
            // C·∫≠p nh·∫≠t summary v·ªÅ 0
            document.getElementById('sum-gpa4').textContent = "0.00";
            document.getElementById('sum-gpa10').textContent = "0.00";
            document.getElementById('sum-tc').textContent = "0";
            document.getElementById('sum-count').textContent = "0";
            document.getElementById('semester-container').innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng M·ªü File JSON ho·∫∑c Th√™m h·ªçc k·ª≥ m·ªõi.</div>';
        }
    }

    document.getElementById('jsonInput').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const imported = JSON.parse(ev.target.result);
                if(Array.isArray(imported)) {
                    semesters = imported;
                } else {
                    processLegacyImport(imported);
                }
                render();
            } catch (err) { alert('File l·ªói!'); }
        };
        reader.readAsText(file);
    });

    function processLegacyImport(data) {
        semesters = [];
        let summerBuffer = {}; 
        for (const year in data) {
            for (const sem in data[year]) {
                const isSummer = sem.toLowerCase().includes('h√®');
                const subList = data[year][sem].map(s => ({
                    id: genId(),
                    name: s.TenLopHocPhan,
                    tc: s.SoTinChi,
                    type: (s.LoaiMon === 'cai_thien' || s.LanHoc > 1) ? 'improve' : 'new',
                    cc: s.DiemThanhPhan?.ChuyenCan_GVHD || '',
                    bt: s.DiemThanhPhan?.BaiTap || '',
                    gk: s.DiemThanhPhan?.GiuaKy || '',
                    ck: s.DiemThanhPhan?.CuoiKy_DoAn || '',
                    score10: s.DiemTongKet.He10
                }));

                if(isSummer) {
                    if(!summerBuffer[year]) summerBuffer[year] = [];
                    summerBuffer[year].push(...subList);
                } else {
                    semesters.push({ id: genId(), name: `${year} - ${sem}`, subjects: subList });
                }
            }
        }
        for(const year in summerBuffer) {
            const hk2Name = `${year} - H·ªçc k·ª≥ 2`;
            const hk2 = semesters.find(s => s.name === hk2Name);
            if(hk2) { hk2.subjects.push(...summerBuffer[year]); } 
            else { semesters.push({ id: genId(), name: hk2Name, subjects: summerBuffer[year] }); }
        }
        semesters.sort((a,b) => a.name.localeCompare(b.name));
    }

    function saveData() {
        if(semesters.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!"); return; }
        const dataStr = JSON.stringify(semesters, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "bang-diem-gpa.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function calculate() {
        let unique = {}; 
        semesters.forEach(sem => {
            sem.subjects.forEach(sub => {
                if (sub.score10 !== null && sub.score10 !== "" && sub.tc > 0) {
                    const s10 = parseFloat(sub.score10);
                    const letter = scoreToLetter(s10);
                    const s4 = letterTo4(letter);
                    const key = sub.name.trim().toLowerCase() + '_' + sub.tc;
                    if (!unique[key] || s4 > unique[key].s4 || (s4 === unique[key].s4 && s10 > unique[key].s10)) {
                        unique[key] = { ...sub, s10, s4, letter, semName: sem.name, semId: sem.id }; 
                    }
                }
            });
        });
        let totalTC = 0, totalP4 = 0, totalP10 = 0, count = 0;
        let list = [];
        for (let key in unique) {
            const s = unique[key];
            totalTC += s.tc;
            totalP4 += s.s4 * s.tc;
            totalP10 += s.s10 * s.tc;
            count++;
            list.push(s);
        }
        return { gpa4: totalTC ? (totalP4/totalTC) : 0, gpa10: totalTC ? (totalP10/totalTC) : 0, tc: totalTC, count: count, list: list };
    }

    function calculateSemStats(sem) {
        let tc = 0, p10 = 0, p4 = 0, countCalculated = 0;
        sem.subjects.forEach(sub => {
             if (sub.score10 !== null && sub.score10 !== "" && sub.tc > 0) {
                 const s10 = parseFloat(sub.score10);
                 const s4 = letterTo4(scoreToLetter(s10));
                 tc += sub.tc;
                 p10 += s10 * sub.tc;
                 p4 += s4 * sub.tc;
                 countCalculated++;
             }
        });
        return {
            totalSubjects: sem.subjects.length, 
            countCalc: countCalculated,
            gpa10: tc ? (p10/tc).toFixed(2) : "0.00",
            gpa4: tc ? (p4/tc).toFixed(2) : "0.00"
        };
    }

    function autoCalcScore(sub) {
        const cc = parseFloat(sub.cc);
        const bt = parseFloat(sub.bt);
        const gk = parseFloat(sub.gk);
        const ck = parseFloat(sub.ck);
        if (!isNaN(cc) && !isNaN(bt) && !isNaN(gk) && !isNaN(ck)) {
            const total = (cc * 0.1) + (bt * 0.2) + (gk * 0.2) + (ck * 0.5);
            sub.score10 = Math.round(total * 10) / 10;
        }
    }

    function scoreToLetter(s) {
        if (s === null || s === "") return "";
        s = parseFloat(s);
        if (s >= 8.5) return 'A';
        if (s >= 7.0) return 'B';
        if (s >= 5.5) return 'C';
        if (s >= 4.0) return 'D';
        return 'F';
    }
    function letterTo4(l) { return { 'A':4, 'B':3, 'C':2, 'D':1, 'F':0 }[l] ?? 0; }
    function genId() { return Math.random().toString(36).substr(2, 9); }

    function render() {
        const container = document.getElementById('semester-container');
        container.innerHTML = '';
        if(semesters.length === 0) return;

        semesters.forEach(sem => {
            const stats = calculateSemStats(sem);
            const card = document.createElement('div');
            card.className = 'card';
            
            let html = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input class="sem-title" value="${sem.name}" onchange="updateSem('${sem.id}', this.value)">
                        <button class="btn btn-danger" onclick="openDeleteModal('${sem.id}')" title="X√≥a k·ª≥ n√†y">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <div class="sem-stats">
                        <span>S·ªë m√¥n: <b>${stats.totalSubjects}</b></span> 
                        <span style="border-left:1px solid #cbd5e1; padding-left:10px">GPA 10: <b>${stats.gpa10}</b></span>
                        <span style="border-left:1px solid #cbd5e1; padding-left:10px">GPA 4: <b style="color:var(--primary-dark)">${stats.gpa4}</b></span>
                    </div>
                </div>
                <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th style="width:25%; text-align:left">T√™n m√¥n h·ªçc</th>
                            <th style="width:50px">TC</th>
                            <th style="width:100px">Lo·∫°i</th>
                            <th style="width:50px">CC</th>
                            <th style="width:50px">BT</th>
                            <th style="width:50px">GK</th>
                            <th style="width:50px">CK</th>
                            <th style="width:70px; background:#eff6ff">T·ªïng(10)</th>
                            <th style="width:50px">Ch·ªØ</th>
                            <th style="width:40px"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sem.subjects.forEach(sub => {
                const letter = scoreToLetter(sub.score10);
                const colorClass = `g-${letter}`;
                
                html += `
                    <tr id="row-${sub.id}">
                        <td style="text-align:left"><input type="text" class="cell-input" style="text-align:left" value="${sub.name}" onchange="upd('${sem.id}','${sub.id}','name',this.value)"></td>
                        <td><input type="number" class="cell-input" value="${sub.tc}" onchange="upd('${sem.id}','${sub.id}','tc',this.value)"></td>
                        <td>
                            <select class="cell-input" onchange="upd('${sem.id}','${sub.id}','type',this.value)">
                                <option value="new" ${sub.type==='new'?'selected':''}>H·ªçc m·ªõi</option>
                                <option value="improve" ${sub.type==='improve'?'selected':''}>C·∫£i thi·ªán</option>
                            </select>
                        </td>
                        <td><input type="number" step="0.1" class="cell-input" value="${sub.cc||''}" onchange="upd('${sem.id}','${sub.id}','cc',this.value)"></td>
                        <td><input type="number" step="0.1" class="cell-input" value="${sub.bt||''}" onchange="upd('${sem.id}','${sub.id}','bt',this.value)"></td>
                        <td><input type="number" step="0.1" class="cell-input" value="${sub.gk||''}" onchange="upd('${sem.id}','${sub.id}','gk',this.value)"></td>
                        <td><input type="number" step="0.1" class="cell-input" value="${sub.ck||''}" onchange="upd('${sem.id}','${sub.id}','ck',this.value)"></td>
                        
                        <td style="background:#eff6ff">
                            <input type="number" step="0.1" class="cell-input" value="${sub.score10!==null?sub.score10:''}" 
                                id="score-${sub.id}"
                                style="font-weight:bold; color:var(--primary-dark)" 
                                onchange="upd('${sem.id}','${sub.id}','score10',this.value)">
                        </td>
                        <td class="${colorClass}" style="font-weight:bold">${letter}</td>
                        <td><button style="border:none; background:none; cursor:pointer; color:#94a3b8" onclick="delSub('${sem.id}','${sub.id}')">‚úï</button></td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            html += `<button class="btn-add-row" onclick="addSub('${sem.id}')">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Th√™m m√¥n h·ªçc
            </button>`;
            card.innerHTML = html;
            container.appendChild(card);
        });

        const stats = calculate();
        document.getElementById('sum-gpa4').textContent = stats.gpa4.toFixed(2);
        document.getElementById('sum-gpa10').textContent = stats.gpa10.toFixed(2);
        document.getElementById('sum-tc').textContent = stats.tc;
        document.getElementById('sum-count').textContent = stats.count;
    }

    // --- ACTIONS ---
    function addSemester() {
        semesters.push({ id: genId(), name: 'K·ª≥ m·ªõi', subjects: [] });
        render();
    }
    function openDeleteModal(id) { pendingDeleteId = id; document.getElementById('deleteModal').classList.add('open'); }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('open'); pendingDeleteId = null; }
    function confirmDelete() { if(pendingDeleteId) { semesters = semesters.filter(s => s.id !== pendingDeleteId); render(); closeDeleteModal(); } }

    function updateSem(id, val) { semesters.find(s=>s.id===id).name = val; }
    function addSub(semId) { semesters.find(s=>s.id===semId).subjects.push({ id: genId(), name: 'M√¥n m·ªõi', tc: 3, type: 'new', score10: null }); render(); }
    function delSub(semId, subId) { const sem = semesters.find(s=>s.id===semId); sem.subjects = sem.subjects.filter(s=>s.id!==subId); render(); }
    function upd(semId, subId, field, val) {
        const sub = semesters.find(s=>s.id===semId).subjects.find(s=>s.id===subId);
        if(['name','type'].includes(field)) sub[field] = val;
        else if(field === 'tc') sub.tc = parseInt(val) || 0;
        else if(field === 'score10') sub.score10 = val===''?null:parseFloat(val);
        else { sub[field] = val; autoCalcScore(sub); }
        render();
    }

    // --- SCRIPT MODAL ---
    function showScriptModal() { document.getElementById('scriptModal').classList.add('open'); }
    function closeScriptModal() { document.getElementById('scriptModal').classList.remove('open'); }
    function copyToClipboard() {
        const code = document.getElementById('jsCodeBlock').innerText;
        navigator.clipboard.writeText(code).then(() => {
            alert("ƒê√£ copy script v√†o b·ªô nh·ªõ t·∫°m!");
        }, () => { alert("Copy th·∫•t b·∫°i!"); });
    }

    // --- SUGGESTIONS ---
    function showSuggestions() { document.getElementById('suggestionModal').classList.add('open'); renderSuggestionContent(); }
    function closeSuggestions() { document.getElementById('suggestionModal').classList.remove('open'); }
    function jumpTo(id) {
        closeSuggestions();
        const row = document.getElementById('row-' + id);
        if(row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.remove('highlight-row'); void row.offsetWidth; row.classList.add('highlight-row');
            const input = document.getElementById('score-' + id);
            if(input) input.focus();
        }
    }
    function renderSuggestionContent() {
        const stats = calculate();
        const target = parseFloat(document.getElementById('targetGPA').value) || 3.2;
        const currentScore = stats.gpa4 * stats.tc;
        const targetScore = target * stats.tc;
        const deficit = targetScore - currentScore;
        const container = document.getElementById('suggestion-list');
        const statusDiv = document.getElementById('target-status');

        if (deficit <= 0) {
            statusDiv.innerHTML = `<span style="color:var(--grade-A)">ƒê√£ ƒë·∫°t m·ª•c ti√™u!</span>`;
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--grade-A); font-weight:600">üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ƒë·∫°t GPA m·ª•c ti√™u.</div>`;
            return;
        }
        statusDiv.innerHTML = `<span style="color:var(--grade-F)">Thi·∫øu <b>${deficit.toFixed(2)}</b> ƒëi·ªÉm h·ªá 4</span>`;
        let candidates = stats.list.filter(s => s.s4 < 4).map(s => ({ ...s, gain: (4 - s.s4) * s.tc })).sort((a, b) => b.gain - a.gain);
        
        let html = '';
        if(candidates.length === 0) { html = `<div style="padding:10px; text-align:center">Kh√¥ng c√≤n m√¥n n√†o kh·∫£ thi ƒë·ªÉ c·∫£i thi·ªán.</div>`; } 
        else {
            candidates.slice(0, 8).forEach(s => {
                html += `
                    <div style="padding:12px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <div style="font-weight:600; color:var(--text)">${s.name} <span style="font-weight:normal; font-size:0.9em; color:#64748b">(${s.tc} TC)</span></div>
                            <div style="font-size:0.8rem; color:#64748b">Hi·ªán t·∫°i: <b class="g-${s.letter}">${s.letter}</b> (${s.semName})</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px">
                            <div style="color:var(--grade-A); font-size:0.9rem; font-weight:600">+ ${s.gain.toFixed(2)}</div>
                            <button onclick="jumpTo('${s.id}')" style="background:white; border:1px solid var(--primary); color:var(--primary); padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">S·ª≠a</button>
                        </div>
                    </div>`;
            });
        }
        container.innerHTML = html;
    }
</script>
</body>
</html>
